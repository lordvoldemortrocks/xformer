<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/parser.js | xFormer</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="xFormer makes data transformations easy on your cognition and hassle-free."><meta property="og:type" content="website"><meta property="og:url" content="https://www.npmjs.com/package/@muhammadkasim/xformer"><meta property="og:site_name" content="xFormer"><meta property="og:title" content="xFormer"><meta property="og:image" content="https://cdn-images-1.medium.com/max/1200/1*w1GC6zZbgdAXDKq01bmFWA.png"><meta property="og:description" content="xFormer makes data transformations easy on your cognition and hassle-free."><meta property="og:author" content="http://www.emumba.com/"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="xFormer"><meta property="twitter:description" content="xFormer makes data transformations easy on your cognition and hassle-free."><meta property="twitter:image" content="https://cdn-images-1.medium.com/max/1200/1*w1GC6zZbgdAXDKq01bmFWA.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a href="https://gitlab.com/muhammadkasim/xformer">Repository</a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bePositive">bePositive</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaultTo">defaultTo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaultToZero">defaultToZero</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getAverageForList">getAverageForList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getFirstMatch">getFirstMatch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getUsedMemoryForSingle">getUsedMemoryForSingle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isJunk">isJunk</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isNothing">isNothing</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isSomething">isSomething</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logger">logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mapIndexed">mapIndexed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-reduceIndexed">reduceIndexed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-subtract">subtract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sum">sum</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sumList">sumList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-typeMatches">typeMatches</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-zipValueWithStep">zipValueWithStep</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaultAll">defaultAll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-differential">differential</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getAvg">getAvg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getUsedMemory">getUsedMemory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mergeWithAdd">mergeWithAdd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mergeWithSubtract">mergeWithSubtract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pickByRegex">pickByRegex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pickFrom">pickFrom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sumAll">sumAll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PALETTE_INFO">PALETTE_INFO</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-parser">parser</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/parser.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/*
  Author: Muhammad Kasim
  This file contains the parsing logic for XFormer queries.
*/

import * as R from &apos;ramda&apos;;
import * as E from &apos;./palette&apos;;
import * as _ from &apos;./helpers&apos;;

const ALIAS_REGEX = /^[a-zA-z0-9_]*/;
const OPENING_PARAN_REGEX = /^[\(]?/;
const CLOSING_PARAN_REGEX = /[\)]?$/;
const SEPARATOR_REGEX = /[,][ ]?/;

/**
 * @param  {string} action
 * @returns {Function}
 *
 * Takes a string representation of a function from the command pallete. It then picks the function name and the provided
 * params from this string and returns the function with the evaluated params. If no matching function is found, R.identity
 * is returned in its place.
 */
function decodeStringyAction(action) {
  return R.pipe(
    R.juxt([
      _.getFirstMatch(ALIAS_REGEX),
      R.pipe(
        R.replace(ALIAS_REGEX, &apos;&apos;),
        R.replace(OPENING_PARAN_REGEX, &apos;&apos;),
        R.replace(CLOSING_PARAN_REGEX, &apos;&apos;),
        R.split(SEPARATOR_REGEX),
        R.without([&apos;&apos;, undefined]),
        R.map(eval)
      )
    ]),
    R.ifElse(
      R.pipe(
        R.prop(0),
        R.has(R.__, E)
      ),
      R.ifElse(
        R.pipe(
          R.prop(1),
          _.isSomething
        ),
        ([a, p]) =&gt; E[a](...p),
        ([a, p]) =&gt; E[a]
      ),
      R.identity
    )
  )(action);
}

/**
 * @param  {Object} action
 * @returns {Function}
 *
 * Takes a JSON representation of a function from the command pallete and returns the function with the evaluated params. If no matching function is found, R.identity
 * is returned in its place.
 */
function decodeObjectAction(action) {
  const { name, params, func } = action;

  if (R.has(name, E)) {
    let _func = [];
    let _params = [];

    if (_.typeMatches(&apos;array&apos;, func) &amp;&amp; _.isSomething(func)) _func = decodePipe(func);
    if (_.isSomething(params)) _params = _.typeMatches(&apos;array&apos;, params) ? params : [params];
    if (_.isSomething(_func)) return E[name](R.pipe(..._func), ..._params);
    return E[name](..._params);
  } else {
    return R.identity;
  }
}

/**
 * @param  {Array&lt;string&gt;} pipe
 * @returns {Array&lt;Function&gt;}
 *
 * Takes a string or Object representation of an action and decodes it into the matching function from command pallete; if no
 * matching function is found, R.identity is put in its place. R.identity is a function that returns the value
 * it was called with. Command pallete is located in src/XFormer/xformerFns.
 */
const _decodePipe = R.cond([
  [_.typeMatches(&apos;string&apos;), decodeStringyAction],
  [_.typeMatches(&apos;object&apos;), decodeObjectAction]
]);

/**
 * @param  {Array&lt;string&gt;} pipe
 * @returns {Array&lt;Function&gt;}
 *
 * Takes an array of strings and replaces each string with the matching function from the command pallete; if no
 * matching function is found, R.identity is put in its place. R.identity is a function that returns the value
 * it was called with. Command pallete is located in src/XFormer/xformerFns.
 */
const decodePipe = R.map(
  R.cond([
    [_.typeMatches(&apos;string&apos;), _decodePipe],
    [_.typeMatches(&apos;object&apos;), _decodePipe],
    [_.typeMatches(&apos;array&apos;), R.map(_decodePipe)]
  ])
);

/**
 * @param  {Object} action
 * @returns {string}
 *
 * Takes a JSON representation of an action and converts it into stringy representation.
 */
const translateObjectToString = R.converge(R.concat, [
  R.prop(&apos;name&apos;),
  R.ifElse(
    R.propSatisfies(_.isSomething, &apos;params&apos;),
    R.pipe(
      R.prop(&apos;params&apos;),
      R.map(R.toString),
      R.join(&apos;, &apos;),
      x =&gt; `(${x})`
    ),
    R.always(&apos;&apos;)
  )
]);

/**
 * @param  {string | Object} action
 * @returns {string} name of the action
 *
 * Takes a string or Object representation of an action and returns the name of the action.
 */
const getActionName = R.curry(action =&gt; {
  return R.cond([
    [_.typeMatches(&apos;string&apos;), R.identity],
    [_.typeMatches(&apos;object&apos;), translateObjectToString],
    [
      _.typeMatches(&apos;array&apos;),
      R.pipe(
        R.map(getActionName),
        R.join(&apos;, &apos;)
      )
    ]
  ])(action);
});

/**
 * @param  {string | Object | Array&lt;string|Object&gt;} fn
 * @param  {Object} info
 * @param  {Object} acc
 * @returns {Object}
 *
 * Takes an action or list of actions, current state of accumulator and updates the accumulator
 * according to the action(s).
 */
const executeAction = R.curry((fn, data) =&gt; {
  return R.cond([
    [_.typeMatches(&apos;function&apos;), R.applyTo(data)],
    [_.typeMatches(&apos;array&apos;), R.converge(R.call, [R.juxt, R.always(data)])]
  ])(fn);
});

/**
 * @param  {string | Object | Array&lt;string|Object&gt;} fn
 * @param  {Object} info
 * @param  {Object} acc
 * @returns {Object}
 *
 * Takes an action or list of actions, current state of accumulator and updates the accumulator
 * according to the action(s).
 */
const updateAccumulator = R.curry((fn, info, acc) =&gt; {
  const executedData = executeAction(fn, acc.result);

  return R.pipe(
    R.over(R.lensProp(&apos;buffer&apos;), R.append({ title: info.name, data: executedData })),
    R.set(R.lensProp(&apos;result&apos;), executedData)
  )(acc);
});

/**
 * @param  {Array&lt;string&gt;} pipe
 * @param  {any} data
 * @returns {any}
 *
 * Takes a pipeline and data as input and performs two actions upon it.
 * 1. Decodes string and Object representations into functions from the command pallete.
 * 2. Executes the functions in a pipeline fashion while keeping track of the output of each step.
 *
 * Returns an object containing the result of executing the pipeline and the corresponding result of each step.
 */
const executePipe = R.curry((data, pipe) =&gt; {
  return R.pipe(
    decodePipe,
    _.reduceIndexed(
      (acc, fn, idx) =&gt; {
        const info = { idx: idx, name: getActionName(R.nth(idx, pipe), idx) };
        return updateAccumulator(fn, info, acc);
      },
      {
        buffer: [],
        result: data
      }
    ),
    R.over(R.lensProp(&apos;buffer&apos;), R.insert(0, { title: &apos;Original Data&apos;, data: data }))
  )(pipe);
});

/**
 * @param  {Object} query
 * @param  {Object} data
 * @returns {Object}
 *
 * Takes a query and data as input and executes all pipelines within the query, with each pipeline receiving the
 * provided data.
 */
export const parser = R.curry((query, data) =&gt; R.map(executePipe(data), query));
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
